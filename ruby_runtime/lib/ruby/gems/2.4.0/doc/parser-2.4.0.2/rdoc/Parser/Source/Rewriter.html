<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Parser::Source::Rewriter - parser-2.4.0.2 Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">Object
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-active_clobber">#active_clobber</a>
    
    <li ><a href="#method-i-active_clobber-3D">#active_clobber=</a>
    
    <li ><a href="#method-i-active_insertions">#active_insertions</a>
    
    <li ><a href="#method-i-active_insertions-3D">#active_insertions=</a>
    
    <li ><a href="#method-i-active_queue">#active_queue</a>
    
    <li ><a href="#method-i-adjacent-3F">#adjacent?</a>
    
    <li ><a href="#method-i-adjacent_insertion_mask">#adjacent_insertion_mask</a>
    
    <li ><a href="#method-i-adjacent_insertions-3F">#adjacent_insertions?</a>
    
    <li ><a href="#method-i-adjacent_position_mask">#adjacent_position_mask</a>
    
    <li ><a href="#method-i-adjacent_updates-3F">#adjacent_updates?</a>
    
    <li ><a href="#method-i-append">#append</a>
    
    <li ><a href="#method-i-can_merge-3F">#can_merge?</a>
    
    <li ><a href="#method-i-clobbered_insertion-3F">#clobbered_insertion?</a>
    
    <li ><a href="#method-i-clobbered_position_mask">#clobbered_position_mask</a>
    
    <li ><a href="#method-i-in_transaction-3F">#in_transaction?</a>
    
    <li ><a href="#method-i-insert_after">#insert_after</a>
    
    <li ><a href="#method-i-insert_after_multi">#insert_after_multi</a>
    
    <li ><a href="#method-i-insert_before">#insert_before</a>
    
    <li ><a href="#method-i-insert_before_multi">#insert_before_multi</a>
    
    <li ><a href="#method-i-merge_actions">#merge_actions</a>
    
    <li ><a href="#method-i-merge_actions-21">#merge_actions!</a>
    
    <li ><a href="#method-i-merge_replacements">#merge_replacements</a>
    
    <li ><a href="#method-i-process">#process</a>
    
    <li ><a href="#method-i-raise_clobber_error">#raise_clobber_error</a>
    
    <li ><a href="#method-i-record_insertion">#record_insertion</a>
    
    <li ><a href="#method-i-record_replace">#record_replace</a>
    
    <li ><a href="#method-i-remove">#remove</a>
    
    <li ><a href="#method-i-replace">#replace</a>
    
    <li ><a href="#method-i-replace_actions">#replace_actions</a>
    
    <li ><a href="#method-i-replace_compatible_with_insertion-3F">#replace_compatible_with_insertion?</a>
    
    <li ><a href="#method-i-transaction">#transaction</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Parser::Source::Rewriter">
  <h1 id="class-Parser::Source::Rewriter" class="class">
    class Parser::Source::Rewriter
  </h1>

  <section class="description">
    
<p>{Rewriter} performs the heavy lifting in the source rewriting process. It
schedules code updates to be performed in the correct order and verifies
that no two updates <em>clobber</em> each other, that is, attempt to modify
the same section of code. (However, if two updates modify the same section
in exactly the same way, they are merged.)</p>

<p>If it is detected that one update clobbers another one, an `:error` and a
`:note` diagnostics describing both updates are generated and passed to the
diagnostic engine. After that, an exception is raised.</p>

<p>The default diagnostic engine consumer simply prints the diagnostics to
`stderr`.</p>

<p>@!attribute [r] <a
href="Rewriter.html#attribute-i-source_buffer">#source_buffer</a></p>

<pre class="ruby"><span class="ruby-ivar">@return</span> [<span class="ruby-constant">Source</span><span class="ruby-operator">::</span><span class="ruby-constant">Buffer</span>]
</pre>

<p>@!attribute [r] diagnostics</p>

<pre class="ruby"><span class="ruby-ivar">@return</span> [<span class="ruby-constant">Diagnostic</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>]
</pre>

<p>@api public</p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-diagnostics" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">diagnostics</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-source_buffer" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">source_buffer</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(source_buffer)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>@param [Source::Buffer] <a
href="Rewriter.html#attribute-i-source_buffer">#source_buffer</a></p>
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 32</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">source_buffer</span>)
  <span class="ruby-ivar">@diagnostics</span> = <span class="ruby-constant">Diagnostic</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@diagnostics</span>.<span class="ruby-identifier">consumer</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">diag</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">diag</span>.<span class="ruby-identifier">render</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@source_buffer</span> = <span class="ruby-identifier">source_buffer</span>
  <span class="ruby-ivar">@queue</span>         = []
  <span class="ruby-ivar">@clobber</span>       = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@insertions</span>    = <span class="ruby-value">0</span> <span class="ruby-comment"># clobbered zero-length positions; index 0 is the far left</span>

  <span class="ruby-ivar">@insert_before_multi_order</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@insert_after_multi_order</span> = <span class="ruby-value">0</span>

  <span class="ruby-ivar">@pending_queue</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@pending_clobber</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@pending_insertions</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-insert_after" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert_after</span><span
            class="method-args">(range, content)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts new code after the given source range.</p>

<p>@param [Range] range @param [String] content @return [Rewriter] self @raise
[ClobberingError] when clobbering is detected</p>
          
          

          
          <div class="method-source-code" id="insert_after-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 104</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert_after</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">content</span>)
  <span class="ruby-identifier">append</span> <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>.<span class="ruby-identifier">end</span>, <span class="ruby-identifier">content</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-insert_after_multi" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert_after_multi</span><span
            class="method-args">(range, content)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts new code after the given source range by allowing other insertions
at the same position. Note that an insertion with latter invocation comes
<em>after</em> earlier insertion at the same position in the rewritten
source.</p>

<p>@example Inserting &#39;)]&#39;</p>

<pre class="ruby"><span class="ruby-identifier">rewriter</span>.
  <span class="ruby-identifier">insert_after_multi</span>(<span class="ruby-identifier">range</span>, <span class="ruby-string">&#39;)&#39;</span>).
  <span class="ruby-identifier">insert_after_multi</span>(<span class="ruby-identifier">range</span>, <span class="ruby-string">&#39;]&#39;</span>).
  <span class="ruby-identifier">process</span>
</pre>

<p>@param [Range] range @param [String] content @return [Rewriter] self @raise
[ClobberingError] when clobbering is detected</p>
          
          

          
          <div class="method-source-code" id="insert_after_multi-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 125</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert_after_multi</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">content</span>)
  <span class="ruby-ivar">@insert_after_multi_order</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">append</span> <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>.<span class="ruby-identifier">end</span>, <span class="ruby-identifier">content</span>, <span class="ruby-keyword">true</span>, <span class="ruby-ivar">@insert_after_multi_order</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-insert_before" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert_before</span><span
            class="method-args">(range, content)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts new code before the given source range.</p>

<p>@param [Range] range @param [String] content @return [Rewriter] self @raise
[ClobberingError] when clobbering is detected</p>
          
          

          
          <div class="method-source-code" id="insert_before-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 70</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert_before</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">content</span>)
  <span class="ruby-identifier">append</span> <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin</span>, <span class="ruby-identifier">content</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-insert_before_multi" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">insert_before_multi</span><span
            class="method-args">(range, content)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Inserts new code before the given source range by allowing other insertions
at the same position. Note that an insertion with latter invocation comes
<em>before</em> earlier insertion at the same position in the rewritten
source.</p>

<p>@example Inserting &#39;[(&#39;</p>

<pre class="ruby"><span class="ruby-identifier">rewriter</span>.
  <span class="ruby-identifier">insert_before_multi</span>(<span class="ruby-identifier">range</span>, <span class="ruby-string">&#39;(&#39;</span>).
  <span class="ruby-identifier">insert_before_multi</span>(<span class="ruby-identifier">range</span>, <span class="ruby-string">&#39;[&#39;</span>).
  <span class="ruby-identifier">process</span>
</pre>

<p>@param [Range] range @param [String] content @return [Rewriter] self @raise
[ClobberingError] when clobbering is detected</p>
          
          

          
          <div class="method-source-code" id="insert_before_multi-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 91</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">insert_before_multi</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">content</span>)
  <span class="ruby-ivar">@insert_before_multi_order</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">append</span> <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin</span>, <span class="ruby-identifier">content</span>, <span class="ruby-keyword">true</span>, <span class="ruby-ivar">@insert_before_multi_order</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-process" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">process</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Applies all scheduled changes to the `source_buffer` and returns modified
source as a new string.</p>

<p>@return [String]</p>
          
          

          
          <div class="method-source-code" id="process-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 148</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_transaction?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Do not call #{self.class}##{__method__} inside a transaction&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">adjustment</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">source</span>     = <span class="ruby-ivar">@source_buffer</span>.<span class="ruby-identifier">source</span>.<span class="ruby-identifier">dup</span>

  <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">action</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">begin_pos</span> = <span class="ruby-identifier">action</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">adjustment</span>
    <span class="ruby-identifier">end_pos</span>   = <span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">action</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">length</span>

    <span class="ruby-identifier">source</span>[<span class="ruby-identifier">begin_pos</span><span class="ruby-operator">...</span><span class="ruby-identifier">end_pos</span>] = <span class="ruby-identifier">action</span>.<span class="ruby-identifier">replacement</span>

    <span class="ruby-identifier">adjustment</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">action</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">action</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">length</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">source</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-remove" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Removes the source range.</p>

<p>@param [Range] range @return [Rewriter] self @raise [ClobberingError] when
clobbering is detected</p>
          
          

          
          <div class="method-source-code" id="remove-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 58</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove</span>(<span class="ruby-identifier">range</span>)
  <span class="ruby-identifier">append</span> <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>, <span class="ruby-string">&#39;&#39;</span>.<span class="ruby-identifier">freeze</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-replace" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">replace</span><span
            class="method-args">(range, content)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Replaces the code of the source range `range` with `content`.</p>

<p>@param [Range] range @param [String] content @return [Rewriter] self @raise
[ClobberingError] when clobbering is detected</p>
          
          

          
          <div class="method-source-code" id="replace-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">replace</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">content</span>)
  <span class="ruby-identifier">append</span> <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">content</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-transaction" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">transaction</span><span
            class="method-args">() { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Provides a protected block where a sequence of multiple rewrite actions are
handled atomically. If any of the actions failed by clobbering, all the
actions are rolled back.</p>

<p>@example</p>

<pre class="ruby"><span class="ruby-keyword">begin</span>
  <span class="ruby-identifier">rewriter</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">rewriter</span>.<span class="ruby-identifier">insert_before</span>(<span class="ruby-identifier">range_of_something</span>, <span class="ruby-string">&#39;(&#39;</span>)
    <span class="ruby-identifier">rewriter</span>.<span class="ruby-identifier">insert_after</span>(<span class="ruby-identifier">range_of_something</span>, <span class="ruby-string">&#39;)&#39;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Parser</span><span class="ruby-operator">::</span><span class="ruby-constant">ClobberingError</span>
<span class="ruby-keyword">end</span>
</pre>

<p>@raise [RuntimeError] when no block is passed @raise [RuntimeError] when
already in a transaction</p>
          
          

          
          <div class="method-source-code" id="transaction-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">transaction</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">block_given?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{self.class}##{__method__} requires block&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_transaction?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Nested transaction is not supported&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@pending_queue</span> = <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-ivar">@pending_clobber</span> = <span class="ruby-ivar">@clobber</span>
  <span class="ruby-ivar">@pending_insertions</span> = <span class="ruby-ivar">@insertions</span>

  <span class="ruby-keyword">yield</span>

  <span class="ruby-ivar">@queue</span> = <span class="ruby-ivar">@pending_queue</span>
  <span class="ruby-ivar">@clobber</span> = <span class="ruby-ivar">@pending_clobber</span>
  <span class="ruby-ivar">@insertions</span> = <span class="ruby-ivar">@pending_insertions</span>

  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-ivar">@pending_queue</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@pending_clobber</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@pending_insertions</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="private-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Private Instance Methods</h3>
       </header>

    
      <div id="method-i-active_clobber" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_clobber</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="active_clobber-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 445</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_clobber</span>
  <span class="ruby-ivar">@pending_clobber</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@clobber</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-active_clobber-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_clobber=</span><span
            class="method-args">(value)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="active_clobber-3D-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 453</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_clobber=</span>(<span class="ruby-identifier">value</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@pending_clobber</span>
    <span class="ruby-ivar">@pending_clobber</span> = <span class="ruby-identifier">value</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@clobber</span> = <span class="ruby-identifier">value</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-active_insertions" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_insertions</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="active_insertions-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 449</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_insertions</span>
  <span class="ruby-ivar">@pending_insertions</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@insertions</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-active_insertions-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_insertions=</span><span
            class="method-args">(value)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="active_insertions-3D-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 461</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_insertions=</span>(<span class="ruby-identifier">value</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@pending_insertions</span>
    <span class="ruby-ivar">@pending_insertions</span> = <span class="ruby-identifier">value</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@insertions</span> = <span class="ruby-identifier">value</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-active_queue" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_queue</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="active_queue-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 441</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_queue</span>
  <span class="ruby-ivar">@pending_queue</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@queue</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjacent-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjacent?</span><span
            class="method-args">(range1, range2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjacent-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 469</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjacent?</span>(<span class="ruby-identifier">range1</span>, <span class="ruby-identifier">range2</span>)
  <span class="ruby-identifier">range1</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">range2</span>.<span class="ruby-identifier">end_pos</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">range2</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">range1</span>.<span class="ruby-identifier">end_pos</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjacent_insertion_mask" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjacent_insertion_mask</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjacent_insertion_mask-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjacent_insertion_mask</span>(<span class="ruby-identifier">range</span>)
  ((<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">range</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjacent_insertions-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjacent_insertions?</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjacent_insertions-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 335</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjacent_insertions?</span>(<span class="ruby-identifier">range</span>)
  <span class="ruby-comment"># Just retrieve insertions which have not been merged with an adjacent</span>
  <span class="ruby-comment"># remove or replace.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">active_insertions</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">adjacent_insertion_mask</span>(<span class="ruby-identifier">range</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">active_queue</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">adjacent?</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjacent_position_mask" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjacent_position_mask</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjacent_position_mask-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 316</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjacent_position_mask</span>(<span class="ruby-identifier">range</span>)
  ((<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">range</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adjacent_updates-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjacent_updates?</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adjacent_updates-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 346</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjacent_updates?</span>(<span class="ruby-identifier">range</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">active_clobber</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">adjacent_position_mask</span>(<span class="ruby-identifier">range</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">active_queue</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">adjacent?</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>) }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-append" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">append</span><span
            class="method-args">(action)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Schedule a code update. If it overlaps with another update, check whether
they conflict, and raise a clobbering error if they do. (As a special case,
zero-length ranges at the same position are considered to “overlap”.)
Otherwise, merge them.</p>

<p>Updates which are adjacent to each other, but do not overlap, are also
merged.</p>

<p>RULES:</p>
<ul><li>
<p>Insertion (“replacing” a zero-length range):</p>
<ul><li>
<p>Two insertions at the same point conflict. This is true even if the earlier
insertion has already been merged with an adjacent update, and even if they
are both inserting the same text.</p>
</li><li>
<p>An insertion never conflicts with a replace or remove operation on its
right or left side, which does not overlap it (in other words, which does
not update BOTH its right and left sides).</p>
</li><li>
<p>An insertion always conflicts with a remove operation which spans both its
sides.</p>
</li><li>
<p>An insertion conflicts with a replace operation which spans both its sides,
unless the replacement text is longer than the replaced text by the size of
the insertion (or more), and the portion of replacement text immediately
after the insertion position is identical to the inserted text.</p>
</li></ul>
</li><li>
<p>Removal operations never conflict with each other.</p>
</li><li>
<p>Replacement operations:</p>
<ul><li>
<p>Take the portion of each replacement text which falls within:</p>
<ul><li>
<p>The other operation&#39;s replaced region</p>
</li><li>
<p>The other operation&#39;s replacement text, if it extends past the end of
its own replaced region (in other words, if the replacement text is longer
than the text it replaces)</p>
</li></ul>
</li><li>
<p>If and only if the taken texts are identical for both operations, they do
not conflict.</p>
</li></ul>
</li></ul>
          
          

          
          <div class="method-source-code" id="append-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 249</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">append</span>(<span class="ruby-identifier">action</span>)
  <span class="ruby-identifier">range</span> = <span class="ruby-identifier">action</span>.<span class="ruby-identifier">range</span>

  <span class="ruby-comment"># Is this an insertion?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-comment"># Replacing nothing with... nothing?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">action</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">empty?</span>

    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">action</span>.<span class="ruby-identifier">allow_multiple_insertions?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">conflicting</span> = <span class="ruby-identifier">clobbered_insertion?</span>(<span class="ruby-identifier">range</span>))
      <span class="ruby-identifier">raise_clobber_error</span>(<span class="ruby-identifier">action</span>, [<span class="ruby-identifier">conflicting</span>])
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">record_insertion</span>(<span class="ruby-identifier">range</span>)

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">adjacent</span> = <span class="ruby-identifier">adjacent_updates?</span>(<span class="ruby-identifier">range</span>))
      <span class="ruby-identifier">conflicting</span> = <span class="ruby-identifier">adjacent</span>.<span class="ruby-identifier">find</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">overlaps?</span>(<span class="ruby-identifier">range</span>) <span class="ruby-operator">&amp;&amp;</span>
          <span class="ruby-operator">!</span><span class="ruby-identifier">replace_compatible_with_insertion?</span>(<span class="ruby-identifier">a</span>, <span class="ruby-identifier">action</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">raise_clobber_error</span>(<span class="ruby-identifier">action</span>, [<span class="ruby-identifier">conflicting</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">conflicting</span>

      <span class="ruby-identifier">merge_actions!</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">adjacent</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">active_queue</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">action</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># It&#39;s a replace or remove operation.</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">insertions</span> = <span class="ruby-identifier">adjacent_insertions?</span>(<span class="ruby-identifier">range</span>))
      <span class="ruby-identifier">insertions</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">insertion</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">overlaps?</span>(<span class="ruby-identifier">insertion</span>.<span class="ruby-identifier">range</span>) <span class="ruby-operator">&amp;&amp;</span>
           <span class="ruby-operator">!</span><span class="ruby-identifier">replace_compatible_with_insertion?</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">insertion</span>)
          <span class="ruby-identifier">raise_clobber_error</span>(<span class="ruby-identifier">action</span>, [<span class="ruby-identifier">insertion</span>])
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">action</span> = <span class="ruby-identifier">merge_actions</span>(<span class="ruby-identifier">action</span>, [<span class="ruby-identifier">insertion</span>])
          <span class="ruby-identifier">active_queue</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">insertion</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">adjacent</span> = <span class="ruby-identifier">adjacent_updates?</span>(<span class="ruby-identifier">range</span>))
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">can_merge?</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">adjacent</span>)
        <span class="ruby-identifier">record_replace</span>(<span class="ruby-identifier">range</span>)
        <span class="ruby-identifier">merge_actions!</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">adjacent</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise_clobber_error</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">adjacent</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">record_replace</span>(<span class="ruby-identifier">range</span>)
      <span class="ruby-identifier">active_queue</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">action</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-can_merge-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">can_merge?</span><span
            class="method-args">(action, existing)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="can_merge-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 358</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">can_merge?</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">existing</span>)
  <span class="ruby-comment"># Compare 2 replace/remove operations (neither is an insertion)</span>
  <span class="ruby-identifier">range</span> = <span class="ruby-identifier">action</span>.<span class="ruby-identifier">range</span>

  <span class="ruby-identifier">existing</span>.<span class="ruby-identifier">all?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">other</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">overlap</span> = <span class="ruby-identifier">range</span>.<span class="ruby-identifier">intersect</span>(<span class="ruby-identifier">other</span>.<span class="ruby-identifier">range</span>)
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">overlap</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># adjacent, not overlapping</span>

    <span class="ruby-identifier">repl1_offset</span> = <span class="ruby-identifier">overlap</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>
    <span class="ruby-identifier">repl2_offset</span> = <span class="ruby-identifier">overlap</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>
    <span class="ruby-identifier">repl1_length</span> = [<span class="ruby-identifier">other</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">repl2_offset</span>,
                    <span class="ruby-identifier">other</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">length</span>  <span class="ruby-operator">-</span> <span class="ruby-identifier">repl2_offset</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-identifier">repl2_length</span> = [<span class="ruby-identifier">range</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">repl1_offset</span>,
                    <span class="ruby-identifier">action</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">repl1_offset</span>].<span class="ruby-identifier">max</span>

    <span class="ruby-identifier">replacement1</span> = <span class="ruby-identifier">action</span>.<span class="ruby-identifier">replacement</span>[<span class="ruby-identifier">repl1_offset</span>, <span class="ruby-identifier">repl1_length</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>.<span class="ruby-identifier">freeze</span>
    <span class="ruby-identifier">replacement2</span> = <span class="ruby-identifier">other</span>.<span class="ruby-identifier">replacement</span>[<span class="ruby-identifier">repl2_offset</span>, <span class="ruby-identifier">repl2_length</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>.<span class="ruby-identifier">freeze</span>
    <span class="ruby-identifier">replacement1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">replacement2</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-clobbered_insertion-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clobbered_insertion?</span><span
            class="method-args">(insertion)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="clobbered_insertion-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 324</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clobbered_insertion?</span>(<span class="ruby-identifier">insertion</span>)
  <span class="ruby-identifier">insertion_pos</span> = <span class="ruby-identifier">insertion</span>.<span class="ruby-identifier">begin_pos</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">active_insertions</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">insertion_pos</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-comment"># The clobbered insertion may have already been merged with other</span>
    <span class="ruby-comment"># updates, so it won&#39;t necessarily have the same begin_pos.</span>
    <span class="ruby-identifier">active_queue</span>.<span class="ruby-identifier">find</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">insertion_pos</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">insertion_pos</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">end_pos</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-clobbered_position_mask" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clobbered_position_mask</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="clobbered_position_mask-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 312</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clobbered_position_mask</span>(<span class="ruby-identifier">range</span>)
  ((<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">size</span>) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-in_transaction-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">in_transaction?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="in_transaction-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 437</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">in_transaction?</span>
  <span class="ruby-operator">!</span><span class="ruby-ivar">@pending_queue</span>.<span class="ruby-identifier">nil?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-merge_actions" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">merge_actions</span><span
            class="method-args">(action, existing)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="merge_actions-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 379</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">merge_actions</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">existing</span>)
  <span class="ruby-identifier">actions</span> = <span class="ruby-identifier">existing</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">action</span>).<span class="ruby-identifier">sort_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
    [<span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">end_pos</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">range</span> = <span class="ruby-identifier">actions</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">actions</span>.<span class="ruby-identifier">max_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">end_pos</span> }.<span class="ruby-identifier">range</span>)

  <span class="ruby-constant">Rewriter</span><span class="ruby-operator">::</span><span class="ruby-constant">Action</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">range</span>, <span class="ruby-identifier">merge_replacements</span>(<span class="ruby-identifier">actions</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-merge_actions-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">merge_actions!</span><span
            class="method-args">(action, existing)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="merge_actions-21-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 388</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">merge_actions!</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">existing</span>)
  <span class="ruby-identifier">new_action</span> = <span class="ruby-identifier">merge_actions</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">existing</span>)
  <span class="ruby-identifier">active_queue</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">action</span>)
  <span class="ruby-identifier">replace_actions</span>(<span class="ruby-identifier">existing</span>, <span class="ruby-identifier">new_action</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-merge_replacements" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">merge_replacements</span><span
            class="method-args">(actions)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="merge_replacements-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 394</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">merge_replacements</span>(<span class="ruby-identifier">actions</span>)
  <span class="ruby-identifier">result</span>    = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-identifier">prev_act</span>  = <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">actions</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">act</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">prev_act</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">act</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">disjoint?</span>(<span class="ruby-identifier">prev_act</span>.<span class="ruby-identifier">range</span>)
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">act</span>.<span class="ruby-identifier">replacement</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">prev_end</span> = [<span class="ruby-identifier">prev_act</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">prev_act</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">length</span>,
                  <span class="ruby-identifier">prev_act</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">end_pos</span>].<span class="ruby-identifier">max</span>
      <span class="ruby-identifier">offset</span>   = <span class="ruby-identifier">prev_end</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">act</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">act</span>.<span class="ruby-identifier">replacement</span>[<span class="ruby-identifier">offset</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">offset</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">act</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">size</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">prev_act</span> = <span class="ruby-identifier">act</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-raise_clobber_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">raise_clobber_error</span><span
            class="method-args">(action, existing)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="raise_clobber_error-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 419</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">raise_clobber_error</span>(<span class="ruby-identifier">action</span>, <span class="ruby-identifier">existing</span>)
  <span class="ruby-comment"># cannot replace 3 characters with &quot;foobar&quot;</span>
  <span class="ruby-identifier">diagnostic</span> = <span class="ruby-constant">Diagnostic</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:error</span>,
                              <span class="ruby-value">:invalid_action</span>,
                              { <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">action</span> },
                              <span class="ruby-identifier">action</span>.<span class="ruby-identifier">range</span>)
  <span class="ruby-ivar">@diagnostics</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">diagnostic</span>)

  <span class="ruby-comment"># clobbered by: remove 3 characters</span>
  <span class="ruby-identifier">diagnostic</span> = <span class="ruby-constant">Diagnostic</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:note</span>,
                              <span class="ruby-value">:clobbered</span>,
                              { <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">existing</span>[<span class="ruby-value">0</span>] },
                              <span class="ruby-identifier">existing</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">range</span>)
  <span class="ruby-ivar">@diagnostics</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">diagnostic</span>)

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ClobberingError</span>, <span class="ruby-string">&quot;Parser::Source::Rewriter detected clobbering&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-record_insertion" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">record_insertion</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="record_insertion-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 304</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">record_insertion</span>(<span class="ruby-identifier">range</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">active_insertions</span> = <span class="ruby-identifier">active_insertions</span> <span class="ruby-operator">|</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-record_replace" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">record_replace</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="record_replace-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 308</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">record_replace</span>(<span class="ruby-identifier">range</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">active_clobber</span> = <span class="ruby-identifier">active_clobber</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">clobbered_position_mask</span>(<span class="ruby-identifier">range</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-replace_actions" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">replace_actions</span><span
            class="method-args">(old, updated)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="replace_actions-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 414</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">replace_actions</span>(<span class="ruby-identifier">old</span>, <span class="ruby-identifier">updated</span>)
  <span class="ruby-identifier">old</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">act</span><span class="ruby-operator">|</span> <span class="ruby-identifier">active_queue</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">act</span>) }
  <span class="ruby-identifier">active_queue</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">updated</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-replace_compatible_with_insertion-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">replace_compatible_with_insertion?</span><span
            class="method-args">(replace, insertion)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="replace_compatible_with_insertion-3F-source">
            <pre><span class="ruby-comment"># File lib/parser/source/rewriter.rb, line 352</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">replace_compatible_with_insertion?</span>(<span class="ruby-identifier">replace</span>, <span class="ruby-identifier">insertion</span>)
  (<span class="ruby-identifier">replace</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">replace</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">size</span>) <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">insertion</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&amp;&amp;</span>
    (<span class="ruby-identifier">offset</span> = <span class="ruby-identifier">insertion</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">replace</span>.<span class="ruby-identifier">range</span>.<span class="ruby-identifier">begin_pos</span>) <span class="ruby-operator">&amp;&amp;</span>
    <span class="ruby-identifier">replace</span>.<span class="ruby-identifier">replacement</span>[<span class="ruby-identifier">offset</span>, <span class="ruby-identifier">insertion</span>.<span class="ruby-identifier">replacement</span>.<span class="ruby-identifier">length</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">insertion</span>.<span class="ruby-identifier">replacement</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.1.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

